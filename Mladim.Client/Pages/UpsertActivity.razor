@page "/project/{projectId:int}/activity"
@page "/activity/{activityId:int}"
@using Mladim.Domain.Enums;
@attribute [Authorize]

<MudStack Class="pt-5 pb-8" Spacing="4">
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h5">@(editable ? "Vnesi podatke o aktivnosti" : "Podatki o aktivnosti")</MudText>

         <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
            <MudToggleIconButton Toggled="@editable" ToggledChanged="OnActivityEditableChanged"
                                 Icon="@Icons.Material.Filled.Edit" Color="@Color.Primary" Title="Edit"
                                 ToggledIcon="@Icons.Material.Filled.Save" ToggledColor="@Color.Primary" ToggledTitle="Save" />

            @if(!editable)
            {
                <MudFab Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" @onclick="@(()=> DeleteActivityAsync())" />
            }

             <MudFab Color="Color.Secondary" Size="Size.Small" StartIcon="@Icons.Material.Filled.Cancel" OnClick="CancelProjectAsync" />
         </MudStack>
     </MudStack>

     <MudTextField ReadOnly="!editable" @bind-Value="activity.Attributes.Name" Variant="Variant.Outlined" Label="Ime aktivnosti">@activity.Attributes.Name</MudTextField>
     <MudDateRangePicker ReadOnly="!editable" Variant="Variant.Outlined" Label="Trajanje aktivnosti" @bind-DateRange="activity.DateRange" />
     @if (activity.DateRange.End?.Day == activity.DateRange.Start?.Day && activity.DateRange != default)
    {
        <MudGrid>
            <MudItem xs="6">
                <MudText Typo="Typo.h6">Začetek aktivnosti</MudText>
                <MudTimePicker ReadOnly="!editable" @bind-Time="activity.StartTime" PickerVariant="PickerVariant.Dialog" Label="24 urni prikaz" TimeEditMode="TimeEditMode.OnlyHours" />
            </MudItem>
            <MudItem xs="6">
                <MudText Typo="Typo.h6">Konec aktivnosti</MudText>
                <MudTimePicker ReadOnly="!editable" @bind-Time="activity.EndTime" PickerVariant="PickerVariant.Dialog" Label="24 urni prikaz" TimeEditMode="TimeEditMode.OnlyHours" />
            </MudItem>
        </MudGrid>     
        
    }
    <div>
        <SfRichTextEditor Readonly="!editable" @bind-Value="@activity.Attributes.Description" Placeholder="Nekaj o aktivnosti" />
    </div>

    <MultiSelect ReadOnly="!editable" TItem="ActivityTypes" @bind-EnumValues="activity.Attributes.ActivityTypes" Label="Tip aktivnosti" />

    <MudSelect ReadOnly="!editable" T="NamedEntityVM" ToStringFunc="@((staff)=> staff.FullName)" MultiSelection="true" @bind-SelectedValues="activity.Staff" Variant="Variant.Outlined" Label="Vodje aktivnosti" AnchorOrigin="Origin.BottomCenter">
         @foreach (var staffMember in staff)
        {
            <MudSelectItem Value="staffMember">@staffMember.FullName</MudSelectItem>
        }
    </MudSelect>

    <MudSelect ReadOnly="!editable" T="NamedEntityVM" ToStringFunc="@((staff)=> staff.FullName)" MultiSelection="true" @bind-SelectedValues="activity.Administration" Variant="Variant.Outlined" Label="Drugi sodelujoči" AnchorOrigin="Origin.BottomCenter">
        @foreach (var staffMember in staff)
        {
            <MudSelectItem Value="staffMember">@staffMember.FullName</MudSelectItem>
        }
    </MudSelect>

    <MudSelect ReadOnly="!editable" T="NamedEntityVM" ToStringFunc="@((group)=> group.FullName)" MultiSelection="true" @bind-SelectedValues="activity.Groups" Variant="Variant.Outlined" Label="Skupine udeležencev" AnchorOrigin="Origin.BottomCenter">
        @foreach (var participantGroup in participantGroups)
        {
            <MudSelectItem Value="participantGroup">@participantGroup.FullName</MudSelectItem>
        }
    </MudSelect>

    <MudStack  Row Spacing="5" AlignItems="AlignItems.Center">
        <MudSelect ReadOnly="!editable" T="NamedEntityVM" ToStringFunc="@((partner)=> partner.FullName)" MultiSelection="true" @bind-SelectedValues="activity.Partners" Variant="Variant.Outlined" Label="Partnerji" AnchorOrigin="Origin.BottomCenter">
             @foreach (var partner in partners)
            {
                <MudSelectItem Value="partner">@partner.FullName</MudSelectItem>
            }
        </MudSelect>
        <MudFab Disabled ="!editable" Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.Add" OnClick="AddPartnerAsync" />
    </MudStack>

    <MudStack Row Spacing="5" AlignItems="AlignItems.Center">
        <MudSelect ReadOnly="!editable" T="NamedEntityVM" ToStringFunc="@((participant)=> participant.FullName)" MultiSelection="true" @bind-SelectedValues="activity.Participants" Variant="Variant.Outlined" Label="Udeleženci" AnchorOrigin="Origin.BottomCenter">
             @foreach (var participant in participants)
            {
                <MudSelectItem Value="participant">@participant.FullName</MudSelectItem>
            }
        </MudSelect>
        <MudFab Disabled="!editable" Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.Add" OnClick="AddParticipantAsync" />
    </MudStack>

    <MudStack Row Spacing="5" AlignItems="AlignItems.Baseline" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.body1" Align="Align.Center">Drugi udeleženci (starostna skupina in spol) - skupaj: @TotalAnonymousParticipants.</MudText>
        <MudFab Disabled ="!editable" Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.Add" OnClick="AddAnonymousParticipantAsync" />         
    </MudStack>

     <MudFileUpload Disabled="!editable" T="IReadOnlyList<IBrowserFile>" Multiple MaximumFileCount=5 FilesChanged="UploadFilesToProject">
         <ButtonTemplate>
             <MudButton HtmlTag="label"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.CloudUpload"
                        for="@context">
                Naloži datoteke
             </MudButton>
         </ButtonTemplate>
     </MudFileUpload>
    

    @if (activity.Files.Count > 0)
    {
        <MudPaper Class="d-flex align-content-start flex-wrap flex-grow-1 gap-4" Elevation="0">
            @foreach (var file in activity.Files)
            {
                <MudPaper Class="pa-4 cursor-pointer" Elevation="3" @onclick="()=>SelectedFileAsync(file)">
                    <MudStack Row Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
                        <MudText Typo="Typo.body2">@file.FileName</MudText>
                        <MudIconButton Color=Color.Error Disabled="!editable" Icon="@Icons.Material.Filled.Delete" OnClick="() => DeleteAttachedFileAsync(file)" aria-label="delete" />
                    </MudStack>
                </MudPaper>
            }
        </MudPaper>



       @*  <MudList Clickable="true">
            @foreach (var file in activity.Files)
            {
                <MudListItem Icon="@Icons.Material.Filled.AttachFile" @key="@file" OnClick="() =>SelectedFileAsync(file)">
                    @file.FileName
                    <MudIconButton Disabled="!editable" Icon="@Icons.Material.Filled.Delete" OnClick="() => DeleteAttachedFileAsync(file)" aria-label="delete" />
                </MudListItem>
            }
        </MudList> *@
    }

 </MudStack>

